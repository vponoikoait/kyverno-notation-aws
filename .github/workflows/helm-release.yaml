name: helm-release
on:
  push:
    branches:
      - 'release-*'
env:
  HELM_RELEASE_VERSION: 0.0.6

jobs:
  create-release:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Install | AWS CLI v2
        run: |
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip awscliv2.zip
          sudo ./aws/install --update
      - name: Install | helm
        run: |
          HELM_VERSION=$(curl -Ls https://github.com/helm/helm/releases | grep 'href="/helm/helm/releases/tag/v3.[0-9]*.[0-9]*\"' | sed -E 's/.*\/helm\/helm\/releases\/tag\/(v[0-9\.]+)".*/\1/g' | head -1)
          sudo wget -q https://get.helm.sh/helm-$HELM_VERSION-linux-amd64.tar.gz -O - | tar -xzO linux-amd64/helm > helm
          sudo mv helm /usr/local/bin/helm
          sudo chmod +x /usr/local/bin/helm
      - name: Install | Cosign for image signature
        run: |
          curl -O -L "https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64"
          sudo mv cosign-linux-amd64 /usr/local/bin/cosign
          sudo chmod +x /usr/local/bin/cosign
      - name: Build | Login to ECR docker
        run: aws ecr get-login-password --region ${{ vars.AWS_REGION }} | docker login --username AWS --password-stdin ${{ vars.AWS_ACCOUNT_ID }}.dkr.ecr.${{ vars.AWS_REGION }}.amazonaws.com
      - name: Build | Login to ECR helm
        run: aws ecr get-login-password --region ${{ vars.AWS_REGION }} | helm registry login --username AWS --password-stdin ${{ vars.AWS_ACCOUNT_ID }}.dkr.ecr.${{ vars.AWS_REGION }}.amazonaws.com
      - name: Build | Package helm
        run: |
          helm package \
          charts/kyverno-notation-aws \
          --app-version $HELM_RELEASE_VERSION \
          --version $HELM_RELEASE_VERSION
      - name: Release | Helm Chart
        env:
          HELM_EXPERIMENTAL_OCI: 1
        run: |
          helm push "${{ vars.ECR_REPOSITORY_NAME }}-${HELM_RELEASE_VERSION}.tgz" oci://${{ vars.AWS_ACCOUNT_ID }}.dkr.ecr.${{ vars.AWS_REGION }}.amazonaws.com
      - name: Sign Image | Cosign Sign Image
        run: |
          export AWS_REGION=${{ vars.AWS_REGION }}
          cosign generate-key-pair --kms awskms:///alias/${{ secrets.AWS_CMK_ID }}
          cosign sign --key awskms:///alias/${{ secrets.AWS_CMK_ID }} ${{ vars.AWS_ACCOUNT_ID }}.dkr.ecr.${{ vars.AWS_REGION }}.amazonaws.com/${{ vars.ECR_REPOSITORY_NAME }}:${HELM_RELEASE_VERSION} --upload=true --tlog-upload=false
      - name: Sign Image | Cosign Verify Image
        run: |
          cosign verify --key awskms:///alias/${{ secrets.AWS_CMK_ID }} ${{ vars.AWS_ACCOUNT_ID }}.dkr.ecr.${{ vars.AWS_REGION }}.amazonaws.com/${{ vars.ECR_REPOSITORY_NAME }}:${HELM_RELEASE_VERSION} --private-infrastructure
